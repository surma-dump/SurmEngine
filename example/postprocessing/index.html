<!doctype html>
<style>
  html, body {
    margin: 0;
    padding: 0;
  }
  canvas {
    width: 100vw;
    height: 100vh;
  }
</style>
<canvas></canvas>
<script src="/node_modules/gl-matrix/dist/gl-matrix-min.js"></script>
<script type="module">
import {VAO} from '/dist/VAO.js';
import {Helpers} from '/dist/Helpers.js';
import {Camera} from '/dist/Camera.js';
import {XYPlane} from '/dist/Mesh.js';
import {Program} from '/dist/Program.js';
import {Node} from '/dist/SceneGraph.js';
import {Texture} from '/dist/Texture.js';
import {GlLogger} from '/dist/Debug.js';
import {IndexManager} from '/dist/IndexManager.js';
import {TrackballCamera} from '/dist/TrackballCamera.js';
import {KeyboardState,MouseController} from '/dist/Input.js';

(async function() {
  function range(start, len) {
    return new Array(len).fill().map((_, i) => start + i);
  };

  const vertexShader = fetch('vertex.glsl').then(r => r.text());
  const fragmentShader = fetch('fragment.glsl').then(r => r.text());

  const canvas = document.querySelector('canvas');
  window._gl = canvas.getContext('webgl2');
  window.logger = new GlLogger(_gl);
  window.gl = logger.proxy;

  const image = Helpers.loadImage('uvgrid.jpg');
  const program = new Program(gl)
    .setVertexShader(await vertexShader)
    .setFragmentShader(await fragmentShader);

  const numPoints = XYPlane.numPoints();

  const vaoIndex = new IndexManager();
  const vao = new VAO(gl);
  vao.bind();

  // Vertices
  vao.createVBO()
    .bind()
    .setData(XYPlane.vertices(new Float32Array(numPoints * 3)))
    .setItemSize(3)
    .bindToIndex(vaoIndex.forName('vertex'));

  // UVs
  const uvArray = new Float32Array(numPoints * 2);
  uvArray.set([
    0, 1,
    1, 0,
    0, 0,
    0, 1,
    1, 1,
    1, 0,
  ]);
  vao.createVBO()
    .bind()
    .setData(uvArray)
    .setItemSize(2)
    .bindToIndex(vaoIndex.forName('uv'));

  // Normals
  vao.createVBO()
    .bind()
    .setData(XYPlane.normals(new Float32Array(numPoints * 3)))
    .setItemSize(3)
    .bindToIndex(vaoIndex.forName('normal'));

  program
    .bindInVariable('in_vertex', vaoIndex.forName('vertex'))
    .bindInVariable('in_uv', vaoIndex.forName('uv'))
    .bindInVariable('in_normal', vaoIndex.forName('normal'));

  const camera =
    new Camera()
      .setAspectRatio(gl.canvas.width / gl.canvas.height)
      .setFov(30)
      .setNearPlane(0.1)
      .setFarPlane(1000);

  window.scene = new Node()
    .add(
      new Node('light')
        .move([10, 1, 10])
    )
    .add(
      new Node('player')
        .add(
          new Node('translation')
            .add(
              new Node('rotation_y')
                .add(
                  new Node('rotation_x')
                    .add(
                      new Node('camera', camera)
                    )
                )
            )
        )
        .move([0, 1, 0])
    )
    .add (
      new Node('plane')
        .rotate([1, 0, 0], -90)
        .scale(10)
    )

  program
    .link()
    .activate();

  const viewUniform = program.referenceUniform('view');
  const cameraUniform = program.referenceUniform('camera');
  const lightPositionUniform = program.referenceUniform('lightPosition');
  const modelUniform = program.referenceUniform('model');
  const samplerUniform = program.referenceUniform('sampler');

  const textureIndex = new IndexManager();
  const texture = new Texture(gl);
  texture
    .setTextureID(textureIndex.forName('uvgrid'))
    .activate()
    .bind()
    .setParameters()
    .uploadImage2D(0, await image)
    .generateMipmap();
  samplerUniform.setInteger(textureIndex.forName('uvgrid'));


  gl.clearColor(0, 0, 0, 1);
  gl.enable(gl.DEPTH_TEST);
  gl.enable(gl.CULL_FACE);
  gl.cullFace(gl.BACK);
  Helpers.autosize(gl, _ => {
    camera.setAspectRatio(gl.canvas.width / gl.canvas.height);
    viewUniform.setMatrix4(camera.viewMatrix);
  });

  const keyboard = new KeyboardState();
  const mouse = new MouseController(gl);
  canvas.addEventListener('click', _ => mouse.capture());

  const scratchMatrix = mat4.create();
  const scratchVector = vec4.create();
  const player = scene.findByName('player');
  const cameraObj = scene.findByName('camera');
  const light = scene.findByName('light');
  const plane = scene.findByName('plane');
  const trackballCamera = new TrackballCamera(player, mouse, keyboard);
  window.loop = Helpers.loop(delta => {
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

    trackballCamera.update(delta);

    for(let _ of scene.propagate());
    cameraUniform.setMatrix4(mat4.invert(scratchMatrix, cameraObj.accumulatedTransform));
    vec4.set(scratchVector, 0, 0, 0, 1);
    lightPositionUniform.setVector4(vec4.transformMat4(scratchVector, scratchVector, light.accumulatedTransform));
    modelUniform.setMatrix4(plane.accumulatedTransform);
    // modelUniform.setMatrix4(mat4.create());
    gl.drawArrays(gl.TRIANGLES, 0, numPoints);
    logger.filter = _ => false;
  });

})();

</script>

